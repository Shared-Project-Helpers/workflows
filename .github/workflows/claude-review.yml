name: Claude Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        default: 'claude-opus-4-5-20251101'
        type: string
      review_guidelines:
        description: 'Additional review guidelines (appended to defaults)'
        required: false
        default: ''
        type: string
      diff_limit:
        description: 'Max diff size in bytes'
        required: false
        default: '50000'
        type: string
      excluded_files:
        description: 'Git pathspec for excluded files'
        required: false
        default: ':!*.lock :!package-lock.json'
        type: string
      auto_merge_label:
        description: 'Label that enables auto-merge on approval (empty = disabled)'
        required: false
        default: ''
        type: string
      auto_merge_method:
        description: 'Merge method when auto-merging (merge, squash, rebase)'
        required: false
        default: 'squash'
        type: string
      reviewer_name:
        description: 'Display name for the code reviewer persona'
        required: false
        default: 'Claude'
        type: string
      app_id:
        description: 'GitHub App ID for custom bot identity (leave empty to use github-actions[bot])'
        required: false
        default: ''
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      APP_PRIVATE_KEY:
        required: false
        description: 'GitHub App private key for custom bot identity'
    outputs:
      decision:
        description: 'Review decision (APPROVE, REQUEST_CHANGES, or COMMENT)'
        value: ${{ jobs.review.outputs.decision }}

jobs:
  review:
    name: Code Review
    runs-on: ubuntu-latest
    outputs:
      decision: ${{ steps.review.outputs.decision }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, baseSha, headSha;

            if (context.eventName === 'pull_request' || context.eventName === 'pull_request_target') {
              prNumber = context.payload.pull_request.number;
              baseSha = context.payload.pull_request.base.sha;
              headSha = context.payload.pull_request.head.sha;
            } else {
              prNumber = context.payload.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              baseSha = pr.base.sha;
              headSha = pr.head.sha;
            }

            core.setOutput('number', prNumber);
            core.setOutput('base_sha', baseSha);
            core.setOutput('head_sha', headSha);

      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ steps.pr.outputs.base_sha }}..${{ steps.pr.outputs.head_sha }} -- . ${{ inputs.excluded_files }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" | head -c ${{ inputs.diff_limit }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Review with Claude
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          MODEL: ${{ inputs.model }}
          EXTRA_GUIDELINES: ${{ inputs.review_guidelines }}
        run: |
          pip install anthropic
          python << 'PYTHON_SCRIPT'
          import anthropic
          import os
          import json
          import re

          client = anthropic.Anthropic()

          diff = os.environ.get('PR_DIFF', '')
          pr_number = os.environ.get('PR_NUMBER', '')
          model = os.environ.get('MODEL', 'claude-sonnet-4-20250514')
          extra_guidelines = os.environ.get('EXTRA_GUIDELINES', '')

          extra_section = f"\n\n## Project-Specific Guidelines\n{extra_guidelines}" if extra_guidelines else ""

          prompt = f"""You are a senior code reviewer. Review this pull request diff and provide feedback.

          ## Review Guidelines
          - Focus on bugs, security issues, and logic errors
          - Check for proper error handling
          - Look for potential performance issues
          - Check test coverage for new code
          - Verify no secrets or credentials are committed
          {extra_section}

          ## Response Format
          Respond with a JSON object:
          {{
            "decision": "APPROVE" | "REQUEST_CHANGES" | "COMMENT",
            "summary": "Brief summary of the review",
            "issues": [
              {{
                "severity": "critical" | "major" | "minor" | "suggestion",
                "file": "path/to/file",
                "line": 42,
                "description": "Description of the issue",
                "suggestion": "How to fix it"
              }}
            ]
          }}

          If there are no significant issues, set decision to "APPROVE".
          Only use "REQUEST_CHANGES" for critical or major issues.

          ## Diff
          ```diff
          {diff[:40000]}
          ```
          """

          response = client.messages.create(
              model=model,
              max_tokens=4096,
              messages=[{"role": "user", "content": prompt}]
          )

          result = response.content[0].text

          # Try to extract JSON from the response
          try:
              json_match = re.search(r'\{[\s\S]*\}', result)
              if json_match:
                  review_data = json.loads(json_match.group())
              else:
                  review_data = {"decision": "COMMENT", "summary": result, "issues": []}
          except:
              review_data = {"decision": "COMMENT", "summary": result, "issues": []}

          # Write outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"decision={review_data.get('decision', 'COMMENT')}\n")
              f.write(f"summary={review_data.get('summary', 'Review completed')[:500]}\n")

          with open('review_result.json', 'w') as f:
              json.dump(review_data, f)

          print(json.dumps(review_data, indent=2))
          PYTHON_SCRIPT

      - name: Generate app token
        id: app-token
        if: inputs.app_id != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ inputs.app_id }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          script: |
            const fs = require('fs');
            const reviewData = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));

            const reviewerName = '${{ inputs.reviewer_name }}';
            let body = `## ${reviewerName}'s Code Review\n\n`;
            body += `**Decision:** ${reviewData.decision}\n\n`;
            body += `### Summary\n${reviewData.summary}\n\n`;

            if (reviewData.issues && reviewData.issues.length > 0) {
              body += `### Issues Found\n\n`;
              for (const issue of reviewData.issues) {
                const emoji = {
                  critical: 'ðŸ”´',
                  major: 'ðŸŸ ',
                  minor: 'ðŸŸ¡',
                  suggestion: 'ðŸ’¡'
                }[issue.severity] || 'ðŸ“';

                body += `${emoji} **${issue.severity.toUpperCase()}** `;
                if (issue.file) body += `in \`${issue.file}\``;
                if (issue.line) body += ` (line ${issue.line})`;
                body += `\n`;
                body += `> ${issue.description}\n`;
                if (issue.suggestion) {
                  body += `\n**Suggestion:** ${issue.suggestion}\n`;
                }
                body += `\n`;
              }
            }

            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${{ steps.pr.outputs.number }}`;
            body += `\n---\n*Reviewed by ${reviewerName}*\n\n**PR:** ${prUrl}`;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });

            // Submit review if approving or requesting changes
            if (reviewData.decision === 'APPROVE' || reviewData.decision === 'REQUEST_CHANGES') {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }},
                event: reviewData.decision,
                body: reviewData.summary
              });
            }

      - name: Auto-merge if approved and labeled
        if: steps.review.outputs.decision == 'APPROVE' && inputs.auto_merge_label != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const autoMergeLabel = '${{ inputs.auto_merge_label }}';
            const mergeMethod = '${{ inputs.auto_merge_method }}';

            // Get PR details including labels
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const hasAutoMergeLabel = pr.labels.some(label => label.name === autoMergeLabel);

            if (!hasAutoMergeLabel) {
              console.log(`PR does not have '${autoMergeLabel}' label. Skipping auto-merge.`);
              return;
            }

            console.log(`PR has '${autoMergeLabel}' label. Attempting auto-merge...`);

            try {
              // Enable auto-merge (GitHub will merge when all requirements are met)
              await github.graphql(`
                mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: $mergeMethod
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `, {
                pullRequestId: pr.node_id,
                mergeMethod: mergeMethod.toUpperCase()
              });

              console.log('Auto-merge enabled successfully.');

              // Post comment about auto-merge
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ðŸ¤– **Auto-merge enabled.** This PR will be merged automatically when all required checks pass.`
              });
            } catch (error) {
              console.log(`Could not enable auto-merge: ${error.message}`);
              // Fallback: try direct merge if auto-merge not available
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: mergeMethod
                });
                console.log('PR merged directly.');
              } catch (mergeError) {
                console.log(`Could not merge PR: ${mergeError.message}`);
              }
            }
