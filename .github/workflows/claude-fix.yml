name: Claude Fix Agent

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        default: 'claude-opus-4-5-20251101'
        type: string
      pr_number:
        description: 'Pull request number to fix'
        required: true
        type: string
      max_tokens:
        description: 'Max tokens for fix response'
        required: false
        default: '8192'
        type: string
      commit_author_name:
        description: 'Git author name for fix commits'
        required: false
        default: 'Claude Fix Agent'
        type: string
      commit_author_email:
        description: 'Git author email for fix commits'
        required: false
        default: 'claude-fix-agent@users.noreply.github.com'
        type: string
      fixer_name:
        description: 'Display name for the fix agent persona'
        required: false
        default: 'Claude Fix Agent'
        type: string
      app_id:
        description: 'GitHub App ID for custom bot identity (leave empty to use github-actions[bot])'
        required: false
        default: ''
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      PAT:
        required: false
        description: 'Personal Access Token for pushing (enables workflow triggers)'
      APP_PRIVATE_KEY:
        required: false
        description: 'GitHub App private key for custom bot identity'
    outputs:
      files_changed:
        description: 'Number of files changed'
        value: ${{ jobs.fix.outputs.files_changed }}

jobs:
  fix:
    name: Apply Fixes
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.fix.outputs.files_changed }}

    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            core.setOutput('number', prNumber);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_sha', pr.base.sha);

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.PAT || github.token }}

      - name: Get review comments
        id: comments
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }}
            });

            // Find the most recent Claude review
            const claudeReview = comments
              .filter(c => c.body.includes('Code Review'))
              .pop();

            if (claudeReview) {
              core.setOutput('review_body', claudeReview.body);
            } else {
              core.setOutput('review_body', 'No review found');
            }

      - name: Get diff for context
        id: diff
        run: |
          DIFF=$(git diff ${{ steps.pr.outputs.base_sha }}..HEAD -- . ':!*.lock' ':!package-lock.json')
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" | head -c 30000 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Apply fixes with Claude
        id: fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REVIEW_BODY: ${{ steps.comments.outputs.review_body }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          MODEL: ${{ inputs.model }}
          MAX_TOKENS: ${{ inputs.max_tokens }}
          FIXER_NAME: ${{ inputs.fixer_name }}
        run: |
          pip install anthropic
          python << 'PYTHON_SCRIPT'
          import anthropic
          import os
          import json
          import re

          client = anthropic.Anthropic()

          review_body = os.environ.get('REVIEW_BODY', '')
          diff = os.environ.get('PR_DIFF', '')
          model = os.environ.get('MODEL', 'claude-sonnet-4-20250514')
          max_tokens = int(os.environ.get('MAX_TOKENS', '8192'))

          prompt = f"""You are a senior developer fixing code review issues.

          ## Review Feedback
          {review_body}

          ## Current Diff
          ```diff
          {diff[:25000]}
          ```

          ## Instructions
          1. Analyze the review feedback and identify specific fixes needed
          2. For each fix, provide the exact file changes

          Respond with a JSON object containing fixes to apply:
          {{
            "fixes": [
              {{
                "file": "path/to/file",
                "description": "What this fix does",
                "search": "exact code to find (multiple lines ok)",
                "replace": "exact replacement code"
              }}
            ],
            "commit_message": "fix: brief single-line description"
          }}

          IMPORTANT:
          - The commit_message MUST be a single line (no newlines)
          - The "search" field must match EXACTLY what's in the file (including whitespace)
          - Keep fixes minimal and focused on the review feedback
          - Do not make unrelated changes
          - If no fixes are needed, return {{"fixes": [], "commit_message": ""}}
          """

          response = client.messages.create(
              model=model,
              max_tokens=max_tokens,
              messages=[{"role": "user", "content": prompt}]
          )

          result = response.content[0].text

          # Extract JSON
          try:
              json_match = re.search(r'\{[\s\S]*\}', result)
              if json_match:
                  fix_data = json.loads(json_match.group())
              else:
                  fix_data = {"fixes": [], "commit_message": ""}
          except Exception as e:
              print(f"Error parsing response: {e}")
              fix_data = {"fixes": [], "commit_message": ""}

          # Apply fixes
          files_changed = []
          for fix in fix_data.get('fixes', []):
              file_path = fix.get('file', '')
              search = fix.get('search', '')
              replace = fix.get('replace', '')

              if not file_path or not search:
                  continue

              try:
                  with open(file_path, 'r') as f:
                      content = f.read()

                  if search in content:
                      new_content = content.replace(search, replace, 1)
                      with open(file_path, 'w') as f:
                          f.write(new_content)
                      files_changed.append(file_path)
                      print(f"✓ Fixed: {file_path} - {fix.get('description', '')}")
                  else:
                      print(f"✗ Could not find match in {file_path}")
              except Exception as e:
                  print(f"✗ Error fixing {file_path}: {e}")

          # Write outputs - sanitize commit message to single line
          commit_msg = fix_data.get('commit_message', 'fix: apply review feedback')
          # Replace newlines and limit length for safe output
          commit_msg = commit_msg.replace('\n', ' ').replace('\r', '').strip()[:200]

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"files_changed={len(files_changed)}\n")
              f.write(f"commit_message={commit_msg}\n")

          print(f"\nTotal files changed: {len(files_changed)}")
          PYTHON_SCRIPT

      - name: Commit and push fixes
        if: steps.fix.outputs.files_changed != '0'
        run: |
          git config user.name "${{ inputs.commit_author_name }}"
          git config user.email "${{ inputs.commit_author_email }}"

          git add -A
          git commit -m "${{ steps.fix.outputs.commit_message }}

          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push origin ${{ steps.pr.outputs.head_ref }}

      - name: Generate app token
        id: app-token
        if: inputs.app_id != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ inputs.app_id }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          script: |
            const filesChanged = parseInt('${{ steps.fix.outputs.files_changed }}') || 0;
            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${{ steps.pr.outputs.number }}`;
            const fixerName = '${{ inputs.fixer_name }}';

            let body;
            if (filesChanged > 0) {
              body = `## ${fixerName}

            Applied ${filesChanged} fix(es) based on review feedback.

            **Commit:** \`${{ steps.fix.outputs.commit_message }}\`

            The review agent will run again automatically to verify the fixes.

            ---
            *${fixerName}*

            **PR:** ${prUrl}`;
            } else {
              body = `## ${fixerName}

            No automatic fixes could be applied. The issues may require manual intervention.

            Please review the feedback and make changes manually, or comment \`@claude fix\` with more specific instructions.

            ---
            *${fixerName}*

            **PR:** ${prUrl}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });
