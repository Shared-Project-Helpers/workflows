name: Claude Performance Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use'
        required: false
        default: 'claude-opus-4-6'
        type: string
      perf_guidelines:
        description: 'Additional performance review guidelines (appended to defaults)'
        required: false
        default: ''
        type: string
      diff_limit:
        description: 'Max diff size in bytes'
        required: false
        default: '50000'
        type: string
      excluded_files:
        description: 'Git pathspec for excluded files'
        required: false
        default: ':!*.lock :!package-lock.json'
        type: string
      reviewer_name:
        description: 'Display name for the performance reviewer persona'
        required: false
        default: 'Performance Reviewer'
        type: string
      app_id:
        description: 'GitHub App ID for custom bot identity (leave empty to use github-actions[bot])'
        required: false
        default: ''
        type: string
      trigger_fix_on_request_changes:
        description: 'Trigger fix workflow when review requests changes'
        required: false
        default: 'true'
        type: string
      fix_workflow_id:
        description: 'Fix workflow filename to dispatch'
        required: false
        default: 'claude-issue-fix.yml'
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      APP_PRIVATE_KEY:
        required: false
        description: 'GitHub App private key for custom bot identity'
    outputs:
      decision:
        description: 'Review decision (APPROVE, REQUEST_CHANGES, or COMMENT)'
        value: ${{ jobs.review.outputs.decision }}
      pr_number:
        description: 'Pull request number'
        value: ${{ jobs.review.outputs.pr_number }}
      head_ref:
        description: 'PR head branch ref'
        value: ${{ jobs.review.outputs.head_ref }}

jobs:
  review:
    name: Performance Review
    runs-on: ubuntu-latest
    outputs:
      decision: ${{ steps.review.outputs.decision }}
      pr_number: ${{ steps.pr.outputs.number }}
      head_ref: ${{ steps.pr.outputs.head_ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, baseSha, headSha, headRef;

            if (context.eventName === 'pull_request' || context.eventName === 'pull_request_target') {
              prNumber = context.payload.pull_request.number;
              baseSha = context.payload.pull_request.base.sha;
              headSha = context.payload.pull_request.head.sha;
              headRef = context.payload.pull_request.head.ref;
            } else {
              prNumber = context.payload.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              baseSha = pr.base.sha;
              headSha = pr.head.sha;
              headRef = pr.head.ref;
            }

            core.setOutput('number', prNumber);
            core.setOutput('base_sha', baseSha);
            core.setOutput('head_sha', headSha);
            core.setOutput('head_ref', headRef);

      - name: Get diff
        id: diff
        run: |
          DIFF=$(git diff ${{ steps.pr.outputs.base_sha }}..${{ steps.pr.outputs.head_sha }} -- . ${{ inputs.excluded_files }})
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" | head -c ${{ inputs.diff_limit }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Review performance with Claude
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_DIFF: ${{ steps.diff.outputs.diff }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          MODEL: ${{ inputs.model }}
          EXTRA_GUIDELINES: ${{ inputs.perf_guidelines }}
        run: |
          pip install anthropic
          python << 'PYTHON_SCRIPT'
          import anthropic
          import os
          import json
          import re

          client = anthropic.Anthropic()

          diff = os.environ.get('PR_DIFF', '')
          pr_number = os.environ.get('PR_NUMBER', '')
          model = os.environ.get('MODEL', 'claude-opus-4-6')
          extra_guidelines = os.environ.get('EXTRA_GUIDELINES', '')

          extra_section = f"\n\n## Project-Specific Performance Guidelines\n{extra_guidelines}" if extra_guidelines else ""

          prompt = f"""You are a senior performance engineer. Review this pull request diff focusing EXCLUSIVELY on performance, efficiency, and cost concerns.

          ## Performance Review Guidelines
          - **Client-server efficiency**: Unnecessary API calls, missing pagination, over-fetching data
          - **Bandwidth**: Large payloads, missing compression, redundant data transfer
          - **Caching**: Missing cache opportunities, stale cache bugs, cache invalidation issues
          - **Algorithm complexity**: O(n^2) or worse in hot paths, unnecessary iterations
          - **Memory**: Leaks, unbounded growth, large allocations, retained references
          - **Network**: Missing timeouts, no retry with backoff, connection pool exhaustion
          - **Resource cleanup**: Unclosed streams, missing disposal, leaked coroutines/goroutines
          - **Cost optimization**: Wasteful cloud resource usage, inefficient queries, missing indexes
          {extra_section}

          ## Severity Definitions
          - **critical**: Will cause outages, OOMs, or data loss at scale
          - **major**: Measurable performance degradation under normal load
          - **minor**: Suboptimal but acceptable for current scale

          ## Response Format
          Respond with a JSON object:
          {{
            "decision": "APPROVE" | "REQUEST_CHANGES" | "COMMENT",
            "summary": "Brief summary of the performance review",
            "issues": [
              {{
                "severity": "critical" | "major" | "minor" | "suggestion",
                "category": "api-efficiency" | "bandwidth" | "caching" | "algorithm" | "memory" | "network" | "resource-cleanup" | "cost",
                "file": "path/to/file",
                "line": 42,
                "description": "Description of the performance issue",
                "suggestion": "How to fix it"
              }}
            ]
          }}

          If there are no significant performance issues, set decision to "APPROVE".
          Only use "REQUEST_CHANGES" for critical or major performance issues.
          Do NOT review for general code quality, style, or logic bugs â€” that is handled by a separate reviewer.

          ## Diff
          ```diff
          {diff[:40000]}
          ```
          """

          response = client.messages.create(
              model=model,
              max_tokens=4096,
              messages=[{"role": "user", "content": prompt}]
          )

          result = response.content[0].text

          try:
              json_match = re.search(r'\{[\s\S]*\}', result)
              if json_match:
                  review_data = json.loads(json_match.group())
              else:
                  review_data = {"decision": "COMMENT", "summary": result, "issues": []}
          except:
              review_data = {"decision": "COMMENT", "summary": result, "issues": []}

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"decision={review_data.get('decision', 'COMMENT')}\n")
              f.write(f"summary={review_data.get('summary', 'Performance review completed')[:500]}\n")

          with open('review_result.json', 'w') as f:
              json.dump(review_data, f)

          print(json.dumps(review_data, indent=2))
          PYTHON_SCRIPT

      - name: Generate app token
        id: app-token
        if: inputs.app_id != ''
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ inputs.app_id }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token || github.token }}
          script: |
            const fs = require('fs');
            const reviewData = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));

            const reviewerName = '${{ inputs.reviewer_name }}';
            let body = `## ${reviewerName}'s Performance Review\n\n`;
            body += `**Decision:** ${reviewData.decision}\n\n`;
            body += `### Summary\n${reviewData.summary}\n\n`;

            if (reviewData.issues && reviewData.issues.length > 0) {
              body += `### Performance Issues Found\n\n`;
              for (const issue of reviewData.issues) {
                const emoji = {
                  critical: 'ðŸ”´',
                  major: 'ðŸŸ ',
                  minor: 'ðŸŸ¡',
                  suggestion: 'ðŸ’¡'
                }[issue.severity] || 'ðŸ“';

                const category = issue.category ? ` [${issue.category}]` : '';
                body += `${emoji} **${issue.severity.toUpperCase()}**${category} `;
                if (issue.file) body += `in \`${issue.file}\``;
                if (issue.line) body += ` (line ${issue.line})`;
                body += `\n`;
                body += `> ${issue.description}\n`;
                if (issue.suggestion) {
                  body += `\n**Suggestion:** ${issue.suggestion}\n`;
                }
                body += `\n`;
              }
            }

            const prUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${{ steps.pr.outputs.number }}`;
            body += `\n---\n*Reviewed by ${reviewerName} (Performance)*\n\n**PR:** ${prUrl}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: body
            });

            // Submit formal review if approving or requesting changes
            if (reviewData.decision === 'APPROVE' || reviewData.decision === 'REQUEST_CHANGES') {
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: ${{ steps.pr.outputs.number }},
                  event: reviewData.decision,
                  body: `${reviewerName} (Performance): ${reviewData.summary}`
                });
              } catch (error) {
                console.log(`Note: Could not submit formal review (${error.message}). The review comment was posted successfully.`);
              }
            }

      - name: Trigger fix workflow
        if: steps.review.outputs.decision == 'REQUEST_CHANGES' && inputs.trigger_fix_on_request_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '${{ inputs.fix_workflow_id }}',
              ref: '${{ steps.pr.outputs.head_ref }}',
              inputs: {
                pr_number: '${{ steps.pr.outputs.number }}'
              }
            });
